generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Organization {
  id            String         @id @default(cuid())
  name          String
  slug          String         @unique // For subdomain or path routing
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  users         User[]
  teams         Team[]
  stories       Story[]
  messages      Message[]
  storytellings Storytelling[]
  directMessages DirectMessage[]
}

model User {
  id                String         @id @default(cuid())
  clerkId           String         @unique
  email             String         @unique
  name              String?
  lastSeen          DateTime?
  isOnline          Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  organization      Organization?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId    String?
  stories           Story[]
  tasks             Task[]
  messages          Message[]
  teamMembers       TeamMember[]
  teams             Team[]         @relation("TeamMembers")
  ownedTeams        Team[]
  comments          Comment[]
  likes             Like[]
  ownedStorytellings Storytelling[] @relation("OwnedStorytellings")
  memberStorytellings Storytelling[] @relation("MemberStorytellings")
  sentDirectMessages DirectMessage[] @relation("SentMessages")
  receivedDirectMessages DirectMessage[] @relation("ReceivedMessages")
}

model TeamMember {
  id        String   @id @default(cuid())
  userId    String
  teamId    String
  role      String
  user      User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, teamId])
}

model Storytelling {
  id        String   @id @default(cuid())
  title     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  owner     User     @relation("OwnedStorytellings", fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ownerId   String
  members   User[]   @relation("MemberStorytellings")
  stories   Story[]
  team      Team     @relation(fields: [teamId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  teamId    String
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?
}

model Story {
  id             String       @id @default(cuid())
  title          String
  content        String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  author         User         @relation(fields: [authorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  authorId       String
  team           Team         @relation(fields: [teamId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  teamId         String
  storytelling   Storytelling @relation(fields: [storytellingId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  storytellingId String
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?
  tasks          Task[]
  comments       Comment[]
  likes          Like[]
}

model Task {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  assignee    User     @relation(fields: [assigneeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  assigneeId  String
  story       Story    @relation(fields: [storyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  storyId     String
}

model Message {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  sender    User     @relation(fields: [senderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  senderId  String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  teamId    String
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?

  @@index([senderId, teamId])
  @@index([teamId, createdAt])
}

model Team {
  id            String         @id @default(cuid())
  name          String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  owner         User           @relation(fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ownerId       String
  members       User[]         @relation("TeamMembers")
  teamMembers   TeamMember[]
  stories       Story[]
  messages      Message[]
  storytellings Storytelling[]
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation(fields: [authorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  authorId  String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  storyId   String
}

model Like {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  userId    String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  storyId   String

  @@unique([userId, storyId])
}

model DirectMessage {
  id          String   @id @default(cuid())
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  senderId    String
  recipient   User     @relation("ReceivedMessages", fields: [recipientId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  recipientId String
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?

  @@index([senderId, recipientId])
  @@index([recipientId, senderId])
}
